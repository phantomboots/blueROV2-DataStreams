# BlueROV2 TCP-out

These python scripts are designed to fetch depth and heading from MAVLINK messages (output from BlueROV2) and altitude and speed from the waterlinked DVL. The code reformat the data streams for output over a TCP/IP connection that Hypack and TC ComBridge can interface with.

The TCP sockets can get disconnect if hypack crashes or closes and repoens, so a while loop is used to restart the TCP connection once hypack resumes. 

## Depth and heading
The BlueOS software that runs on the Raspberry Pi in the BlueROV's subsea can includes a MAVLINK to REST API that repackages the binary MAVLINK data into a format that can be accessed using the REST API. The resulting data are formatted as JSON data.

This script leverages the Python requests library, which accesses the JSON data key-value pairs at the https endpoint that is generated by the BlueROV. Using the present BlueOS version (Jun 2022), the endpoint for this data is available at XXX.XXX.XXX.XXX:6040, where the XXX values are the IP address of the Raspberry Pi inside the BlueROV2 subsea can. For the BlueROV2 heavy, this data can be accessed at: 192.168.3.200:6040.

The desired MAVLINK data are retrieved from the IP/port listed above. At present, only the vehicle's heading and depth are retrieved, but additional parameters could be retrieved if needed. Data are retrieved, and depth data are converted from mm to meters. Data are then repackaged as a comma seperated value string formatted as:

$BLUDATA, UTC_Date_Time, Depth, Heading, <CR/LF>

This data is then output via a TCP/IP, and instantiates an instance of a TCP server. The connecting application needs to be configured as a TCP client instance. The IP adress is that of the computer that is running this script, and the port is a user selectable value.

## Altitude and speed

Similar to the depth and heading script, the DVL codes listen on 192.168.3.204 for the DVl socket stream. It receives the stream in chunks, 4096 bites. Then opens a TCP socket to connect with hypack or TC ComBridge where it sends the reformatted json string:

$DVLDATA UTC_Date_Time, Altitude, Speed

Not every 4096 bite chunk has an alitude and speed json string contained within it, so there is a check to make sure the string is complete and that it is the correct 'velocity' string type.


